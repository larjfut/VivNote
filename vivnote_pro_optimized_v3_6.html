
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>VivNote — Pro Thought Record (Optimized v3.2)</title>
<meta name="description" content="VivNote Pro: one-time cognitive processing report with insights. Local-only. No database." />
<style>
  :root{
    --bg: linear-gradient(135deg, #F9ECEB 0%, #FDF1F7 50%, #FFD7C2 100%);
    --glass: rgba(255,255,255,0.72);
    --border: rgba(255,255,255,0.65);
    --shadow: 0 12px 36px rgba(91,54,83,0.16);
    --text: #2b2b2b;
    --muted:#6b5f66;
    --accent:#F16667;
    --accent3:#5B3653;
    --radius:18px; --radius-lg:20px;
    --text-xs: clamp(11px, 2.6vw, 12px);
    --text-sm: clamp(12px, 2.9vw, 13px);
    --text-base: clamp(14px, 3.6vw, 16px);
    --text-lg: clamp(16px, 4.2vw, 18px);
    --text-xl: clamp(20px, 4.8vw, 24px);
    --text-2xl: clamp(22px, 5.4vw, 28px);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{background:var(--bg);color:var(--text);font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;line-height:1.45;-webkit-text-size-adjust:100%}
  .wrap{max-width:980px;margin:0 auto;padding:clamp(14px,3vw,24px);padding-bottom:calc(clamp(14px,3vw,24px) + env(safe-area-inset-bottom));padding-top:calc(clamp(12px,2.5vw,20px) + env(safe-area-inset-top))}
  :focus-visible{outline:3px solid #FF6F61;outline-offset:2px;border-radius:10px}
  @media (prefers-reduced-motion: reduce) { * {transition:none !important; animation:none !important;} }

  header{display:flex;align-items:center;gap:12px;margin-bottom:clamp(8px,2vw,16px)}
  .logo{width:42px;height:42px;flex:0 0 42px;background:radial-gradient(circle at 30% 30%, #FFA39E, #FF6F61);border-radius:14px;display:grid;place-items:center;box-shadow:var(--shadow);overflow:hidden}
  .logo svg{width:26px;height:26px}
  .title h1{font-size:var(--text-2xl);line-height:1.15;margin:0}
  .title .sub{color:var(--muted);font-size:var(--text-sm);margin-top:2px}

  .glass{background:var(--glass);backdrop-filter:blur(12px) saturate(140%);-webkit-backdrop-filter:blur(12px) saturate(140%);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);transition:transform .12s ease, box-shadow .2s ease}
  section.card{padding:clamp(12px,2.8vw,18px)}
  .card:hover{transform:translateY(-1px);box-shadow:0 14px 40px rgba(91,54,83,.12)}
  h2{font-size:var(--text-lg);margin:0 0 8px;color:var(--accent3);display:flex;align-items:center;gap:8px}
  h2 .hdr-ico{width:18px;height:18px;flex:0 0 18px;opacity:.9}
  h2:hover{ text-decoration: underline; text-underline-offset: 4px; }
  label{font-size:var(--text-sm);margin:10px 0 6px;display:block}
  input[type="text"],input[type="date"],textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.08);background:rgba(255,255,255,0.95);font-size:var(--text-base);transition: box-shadow .15s ease, border-color .15s ease}
  input:focus-visible, textarea:focus-visible {outline: 2px solid #FF6F61; box-shadow: 0 0 0 4px rgba(255,111,97,.15);}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}

  .emotion-row{display:grid;grid-template-columns:1fr auto 48px;gap:10px;align-items:center;font-size:var(--text-sm);touch-action:pan-y}
  .emotion-row>div:first-child{min-width:120px;display:flex;align-items:center;gap:6px}
  .emotion-row .emo-ico{width:16px;height:16px;flex:0 0 16px;opacity:.9}
  input[type="range"]{width:100%;height:36px;background:transparent;touch-action:manipulation}
  input[type="range"]::-webkit-slider-runnable-track{height:8px;background:rgba(0,0,0,0.12);border-radius:10px}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:22px;height:22px;border-radius:50%;background:var(--accent);border:2px solid white;margin-top:-7px;transition:transform .15s ease}
  input[type="range"]:active::-webkit-slider-thumb{transform:scale(1.05)}
  input[type="range"]::-moz-range-track{height:8px;background:rgba(0,0,0,0.12);border-radius:10px}
  input[type="range"]::-moz-range-thumb{width:22px;height:22px;border:2px solid white;border-radius:50%;background:var(--accent);transition:transform .15s ease}
  input[type="range"]:active::-moz-range-thumb{transform:scale(1.05)}
  @media(max-width:480px){
    .emotion-row{grid-template-columns: 0.95fr 0.75fr 44px}
    .emotion-row input[type="range"]{max-width:82vw}
  }
  .value-badge{display:inline-block;min-width:40px;text-align:right}

  .kpis{display:grid;gap:10px;grid-template-columns:1fr}
  @media(min-width:420px){.kpis{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:768px){.kpis{grid-template-columns:repeat(3,1fr)}}
  .tile{padding:14px;text-align:center;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,0.9);transition: transform .12s ease, box-shadow .2s ease}
  .tile:hover{transform:translateY(-2px);box-shadow:0 16px 40px rgba(91,54,83,.16)}
  .tile .big{font-weight:800;font-size:var(--text-xl)}
  .tile .small{font-size:var(--text-xs);color:var(--muted)}

  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.95);border:1px solid var(--border);font-size:var(--text-xs);margin:2px 6px 2px 0}
  .tips{font-size:var(--text-sm);color:var(--muted);display:flex;align-items:center;gap:6px}
  .tips .tip-ico{width:16px;height:16px;opacity:.9}
  .divider{height:1px;background:rgba(0,0,0,0.06);margin:12px 0}

  .actions{display:grid;grid-template-columns:1fr;gap:10px;padding:12px;background:rgba(255,255,255,0.76);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow);margin-top:10px}
  @media(min-width:560px){.actions{grid-template-columns:2fr 1fr 1fr 1fr}}
  button{position:relative;overflow:hidden;border:0;border-radius:12px;padding:12px 14px;min-height:44px;color:white;background:var(--accent);cursor:pointer;box-shadow:var(--shadow);font-size:var(--text-base);display:flex;gap:8px;align-items:center;justify-content:center;transition:transform .06s ease,opacity .2s ease, filter .2s ease;touch-action:manipulation}
  button:hover{opacity:.92}
  button:active{transform:translateY(1px)}
  button.secondary{background:var(--accent3)}
  button.ghost{background:transparent;color:var(--accent3);border:1px solid var(--accent3)}
  .btn-generate{font-size:clamp(16px,4.2vw,18px);font-weight:800;padding:14px 16px}
  .btn-reset{font-size:var(--text-sm);padding:10px 12px;min-height:40px}

  /* Ripple effect */
  button::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at var(--x,50%) var(--y,50%), rgba(255,255,255,.35), transparent 40%);opacity:0;transition:opacity .25s ease;pointer-events:none}
  button:active::after{opacity:1;transition:opacity .35s ease}

  #report{display:none;padding:clamp(12px,2.8vw,18px)}
  .cover{;border:1px solid transparent;background-clip:padding-box, border-box;background-image:linear-gradient(#fff,#fff), linear-gradient(135deg,#FFA63B,#FF6F61)}
  .cover .brand{display:flex;align-items:center;gap:12px}
  .cover h1{margin:8px 0 4px;font-size:var(--text-2xl)}
  .cover .meta{font-size:var(--text-sm);color:var(--muted)}
  .report h3{margin:16px 0 8px;font-size:var(--text-lg)}
  .report .section{margin:8px 0 14px}

  /* Simple tooltips */
  [data-tip]{position:relative}
  [data-tip]:hover::after{content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 6px);background:#5B3653;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;white-space:nowrap;box-shadow:0 6px 22px rgba(0,0,0,.15)}

  footer{text-align:center;color:var(--muted);font-size:var(--text-xs);margin:24px 0}

  @media print{
    body{background:white}
    header, section.card, footer { display:none !important; }
    #report { display:block !important; }
    .glass{box-shadow:none;border-color:#ddd}
    .tile{background:white}
  }

input, textarea, select, button {
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  font-size: 1rem;
}


h2:nth-of-type(1) svg, h2:nth-of-type(1) { color: #F16667; fill: #F16667; }
h2:nth-of-type(2) svg, h2:nth-of-type(2) { color: #D08B6B; fill: #D08B6B; }
h2:nth-of-type(3) svg, h2:nth-of-type(3) { color: #5B3653; fill: #5B3653; }
h2:nth-of-type(4) svg, h2:nth-of-type(4) { color: #A45C6B; fill: #A45C6B; }
h2:nth-of-type(5) svg, h2:nth-of-type(5) { color: #C26D82; fill: #C26D82; }


.pill .ico svg { display:block; }


/* --- Single-page print compaction --- */
@media print{
  html, body { font-size: 12px; }
  .wrap{ max-width: 100%; padding: 8px !important; }
  #report{ padding: 8px !important; }
  header, section.card, footer { display:none !important; }
  #report { display:block !important; }
  h1{ font-size: 18px !important; margin: 0 0 4px !important; }
  h2{ font-size: 14px !important; margin: 8px 0 4px !important; }
  h3{ font-size: 13px !important; margin: 6px 0 4px !important; }
  .report .section{ margin: 4px 0 6px !important; }
  .kpis{ grid-template-columns: repeat(3, 1fr) !important; gap: 6px !important; }
  .tile{ padding: 8px !important; }
  .tile .big{ font-size: 14px !important; }
  .tile .small{ font-size: 10px !important; }
  .pill{ font-size: 10px !important; padding: 2px 6px !important; }
  .cover{ border: 1px solid #eee !important; padding: 8px !important; background-image: none !important; }
  .brand{ gap: 8px !important; }
  .logo{ width: 36px !important; height: 36px !important; }
  /* Use two columns for report body to save space */
  #report .report{ display: grid !important; grid-template-columns: 1fr 1fr !important; column-gap: 10px !important; }
  /* Avoid awkward breaks within small blocks */
  #report .section, .tile, .pill { break-inside: avoid; }
}

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo glass" aria-label="VivNote logo">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M5 12c0-4 3-7 7-7 0 2-1 3-2.5 4.2C8 10 7 11.2 7 13.5 6 13 5 12.7 5 12z" fill="#FFA63B"/>
          <path d="M19 12c0-4-3-7-7-7 0 2 1 3 2.5 4.2 1.5 1.8 2.5 3 2.5 5.3 1-.5 2-0.8 2-2.5z" fill="#FF6F61"/>
          <circle cx="12" cy="12" r="1.2" fill="#5B3653"/>
        </svg>
      </div>
      <div class="title">
        <h1>VivNote — Pro Thought Record</h1>
        <div class="sub">One-time report with guided insights. Stays on your device.</div>
      </div>
    </header>

    <section class="card glass">
      <h2><svg class="hdr-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h16" stroke="#5B3653" stroke-width="1.6"/></svg> Context</h2>
      <div class="row">
        <div><label for="entryDate">Date</label><input id="entryDate" type="date" inputmode="none"></div>
        <div><label for="sessionId">Session ID</label><input id="sessionId" type="text" placeholder="Auto-generated if empty"></div>
      </div>
      <label for="situation"><svg width='16' height='16' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' stroke='currentColor' fill='none'/></svg> Situation / Trigger</label>
      <input id="situation" type="text" placeholder="What happened? Who, where, when?">
      <label for="thought"><svg width='16' height='16' viewBox='0 0 24 24'><path d='M5 12h14M5 6h14M5 18h14' stroke='currentColor'/></svg> Automatic Thought</label>
      <textarea id="thought" placeholder="First thought or story your mind told you."></textarea>
      <div class="row">
        <div><label for="evidenceFor">Evidence For</label><textarea id="evidenceFor"></textarea></div>
        <div><label for="evidenceAgainst">Evidence Against</label><textarea id="evidenceAgainst"></textarea></div>
      </div>
      <div class="tips"><svg class="tip-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#5B3653" stroke-width="1.4"/><path d="M12 8v.01M11 11h2v5h-2z" stroke="#5B3653" stroke-width="1.4" stroke-linecap="round"/></svg> Tip: Specific, observable facts on both sides improve balanced thinking.</div>
    </section>

    <section class="card glass">
      <h2><svg class="hdr-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21s-6-4.35-6-9a6 6 0 0 1 12 0c0 4.65-6 9-6 9z" stroke="#5B3653" stroke-width="1.6"/></svg> Emotions and Actions</h2>
      <div id="emotions"></div>
      <div class="divider"></div>
      <label for="actions"><svg width='16' height='16' viewBox='0 0 24 24'><path d='M12 2v20M2 12h20' stroke='currentColor'/></svg> Actions / Reactions</label>
      <textarea id="actions" placeholder="What you did, said, or avoided. Include urges if relevant."></textarea>
    </section>

    <section class="card glass">
      <h2><svg class="hdr-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7h10M4 12h16M4 17h8" stroke="#5B3653" stroke-width="1.6"/><path d="M18 7l2 2 3-3" stroke="#5B3653" stroke-width="1.6"/></svg> Reframe and Meaning</h2>
      <label for="reframe">Balanced Thought / Reframe</label>
      <textarea id="reframe" placeholder="Craft a more balanced, compassionate view."></textarea>
      <label for="coreMeaning">Core Meaning</label>
      <textarea id="coreMeaning" placeholder="Deeper belief, value, or need this touches."></textarea>
      <label for="nextStep">Next Step</label>
      <input id="nextStep" type="text" placeholder="One small action to test your reframe.">
    </section>

    <section class="card glass">
      <h2><svg class="hdr-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12h18" stroke="#5B3653" stroke-width="1.6"/><circle cx="12" cy="12" r="7" stroke="#5B3653" stroke-width="1.6"/></svg> Relief and KPIs</h2>
      <div class="emotion-row">
        <div><svg class="emo-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2v6" stroke="#5B3653" stroke-width="1.6"/><circle cx="12" cy="12" r="9" stroke="#5B3653" stroke-width="1.6"/></svg> Overall Distress (before)</div>
        <input type="range" id="distressBefore" min="0" max="100" value="60" oninput="document.getElementById('dbv').textContent=this.value; updateKPIs();">
        <div class="value-badge"><span id="dbv">60</span></div>
      </div>
      <div class="emotion-row">
        <div><svg class="emo-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 22v-6" stroke="#5B3653" stroke-width="1.6"/><circle cx="12" cy="12" r="9" stroke="#5B3653" stroke-width="1.6"/></svg> After Reframe</div>
        <input type="range" id="distressAfter" min="0" max="100" value="30" oninput="document.getElementById('dav').textContent=this.value; updateKPIs();">
        <div class="value-badge"><span id="dav">30</span></div>
      </div>
      <div class="kpis" id="kpis" aria-live="polite"></div>
      <div id="proTips" class="tips"><svg class="tip-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#5B3653" stroke-width="1.4"/><path d="M12 8v.01M11 11h2v5h-2z" stroke="#5B3653" stroke-width="1.4" stroke-linecap="round"/></svg></div>
      <div class="divider"></div>

      <div class="actions glass">
        <button id="gen" class="btn-generate" data-tip="Create the formatted report">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6z" stroke="white" stroke-width="1.6"/><path d="M14 2v6h6" stroke="white" stroke-width="1.6"/><path d="M8 13h8M8 17h8M8 9h2" stroke="white" stroke-width="1.6"/></svg>
          Generate Report
        </button>
        <button class="secondary" id="printBtn" data-tip="Open print dialog to save PDF">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9V3h12v6" stroke="white" stroke-width="1.6"/><rect x="4" y="9" width="16" height="8" rx="2" stroke="white" stroke-width="1.6"/><path d="M7 17h10v4H7z" stroke="white" stroke-width="1.6"/></svg>
          Print / Save PDF
        </button>
        <button class="ghost btn-reset" id="resetBtn" data-tip="Clear the form">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="#5B3653" stroke-width="1.6"/><path d="M21 5v7h-7" stroke="#5B3653" stroke-width="1.6"/></svg>
          Reset
        </button>
        <button class="ghost" id="quickExit" data-tip="Close immediately">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="#5B3653" stroke-width="1.6"/><path d="M9 9l6 6M15 9l-6 6" stroke="#5B3653" stroke-width="1.6"/></svg>
          Quick Exit
        </button>
      </div>

      <div class="tips"><svg class="tip-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#5B3653" stroke-width="1.4"/><path d="M12 8v.01M11 11h2v5h-2z" stroke="#5B3653" stroke-width="1.4" stroke-linecap="round"/></svg> Privacy: No data leaves your device.</div>
    </section>

    <section id="report" class="glass">
      <div class="cover">
        <div class="brand" style="margin-bottom:8px">
          <div class="logo glass" style="width:52px;height:52px"><svg viewBox="0 0 24 24" fill="none">
            <path d="M5 12c0-4 3-7 7-7 0 2-1 3-2.5 4.2C8 10 7 11.2 7 13.5 6 13 5 12.7 5 12z" fill="#FFA63B"/>
            <path d="M19 12c0-4-3-7-7-7 0 2 1 3 2.5 4.2 1.5 1.8 2.5 3 2.5 5.3 1-.5 2-0.8 2-2.5z" fill="#FF6F61"/>
            <circle cx="12" cy="12" r="1.2" fill="#5B3653"/></svg>
          </div>
          <div>
            <h1>VivNote — Customized Thought Record</h1>
            <div class="meta" id="coverMeta"></div>
          </div>
        </div>
        <div id="coverKpis" class="kpis"></div>
      </div>
      <div class="report">
        <h3>Context</h3>
        <div class="section" id="repContext"></div>
        <h3>Evidence</h3>
        <div class="section" id="repEvidence"></div>
        <h3>Emotions</h3>
        <div class="section" id="repEmotions"></div>
        <h3>Reframe and Meaning</h3>
        <div class="section" id="repReframe"></div>
        <h3>Actions and Outcome</h3>
        <div class="section" id="repActions"></div>
        <h3>Insights</h3>
        <div class="section" id="repInsights"></div>
      </div>
    </section>

    <footer>© VivNote. Abstract butterfly mark. Warm palette. Glass UI.</footer>
  </div>

<script>
const EMOTIONS = ["Anxiety","Sadness","Anger","Shame","Guilt","Joy","Calm"];
const EMO_ICONS = {
  Anxiety: "<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><circle cx=\"12\" cy=\"12\" r=\"9\" stroke=\"currentColor\" stroke-width=\"1.6\" fill=\"none\"/><path d=\"M8 16h8\" stroke=\"currentColor\" stroke-width=\"1.6\"/></svg>",
  Sadness: "<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><circle cx=\"12\" cy=\"12\" r=\"9\" stroke=\"currentColor\" stroke-width=\"1.6\" fill=\"none\"/><path d=\"M8 16c1.5-1 6-1 8 0\" stroke=\"currentColor\" stroke-width=\"1.6\"/></svg>",
  Anger: "<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><circle cx=\"12\" cy=\"12\" r=\"9\" stroke=\"currentColor\" stroke-width=\"1.6\" fill=\"none\"/><path d=\"M8 16c1.5-1 6-1 8 0\" stroke=\"currentColor\" stroke-width=\"1.6\"/><path d=\"M8.5 9.5l2-1M15.5 9.5l-2-1\" stroke=\"currentColor\" stroke-width=\"1.6\"/></svg>",
  Shame: "<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><circle cx=\"12\" cy=\"12\" r=\"9\" stroke=\"currentColor\" stroke-width=\"1.6\" fill=\"none\"/><path d=\"M9 15c2-1 4-1 6 0\" stroke=\"currentColor\" stroke-width=\"1.6\"/><path d=\"M9 9l6 6\" stroke=\"currentColor\" stroke-width=\"1.6\"/></svg>",
  Guilt: "<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><circle cx=\"12\" cy=\"12\" r=\"9\" stroke=\"currentColor\" stroke-width=\"1.6\" fill=\"none\"/><path d=\"M8 12h8\" stroke=\"currentColor\" stroke-width=\"1.6\"/></svg>",
  Joy: "<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><circle cx=\"12\" cy=\"12\" r=\"9\" stroke=\"currentColor\" stroke-width=\"1.6\" fill=\"none\"/><path d=\"M8 15c1.5 1 6 1 8 0\" stroke=\"currentColor\" stroke-width=\"1.6\"/></svg>",
  Calm: "<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" aria-hidden=\"true\"><circle cx=\"12\" cy=\"12\" r=\"9\" stroke=\"currentColor\" stroke-width=\"1.6\" fill=\"none\"/><path d=\"M7 14c2 1.5 8 1.5 10 0\" stroke=\"currentColor\" stroke-width=\"1.6\"/></svg>"
};
const REFRAME_LIB = {
  Anxiety:["Focus on controllables: one small step I can take now is ___.","Uncertainty ≠ danger. I can gather more info before deciding."],
  Sadness:["This feeling will pass; it doesn’t define all of me.","What small comfort or support can I allow right now?"],
  Anger:["My anger points to a boundary or value. What boundary needs clarifying?","I can choose a response that serves my long-term goals."],
  Shame:["Mistakes are data, not identity.","How would I talk to a friend in this situation?"],
  Guilt:["If I caused harm, I can make amends; if not, I can release this.","Was the standard unrealistic? What’s a fair expectation?"],
  Joy:["What contributed to this? I can repeat or savor it."],
  Calm:["Notice what supports calm; schedule more of it."]
};
const DISTORTIONS=[
  {label:"All-or-nothing thinking",hints:["always","never","completely","totally","every","none"]},
  {label:"Catastrophizing",hints:["disaster","ruined","terrible","awful","worst","can't handle"]},
  {label:"Mind reading",hints:["they think","everyone thinks","they must","people think"]},
  {label:"Fortune telling",hints:["will fail","won't work","no chance","bound to"]},
  {label:"Overgeneralization",hints:["every time","nothing works","no one","everything"]},
  {label:"Should statements",hints:["should","must","have to","ought"]},
  {label:"Labeling",hints:["i am a","i'm a","they are a"]},
  {label:"Personalization",hints:["it's my fault","because of me"]}
];

function el(tag, attrs={}, children=[]){const e=document.createElement(tag);for(const[k,v] of Object.entries(attrs)){if(k==="class")e.className=v;else if(k==="html")e.innerHTML=v;else e.setAttribute(k,v);} (Array.isArray(children)?children:[children]).forEach(c=>c&&e.appendChild(c)); return e;}

function buildEmotionUI(){
  const root=document.getElementById("emotions");
  EMOTIONS.forEach(name=>{
    const row=el("div",{class:"emotion-row"});
    row.appendChild(el("div",{html:`<svg class='emo-ico' viewBox='0 0 24 24' fill='none' aria-hidden='true'><circle cx='12' cy='12' r='9' stroke='#5B3653' stroke-width='1.6'/></svg> ${name}`}));
    const range=el("input",{type:"range",min:"0",max:"100",value:(name==="Joy"||name==="Calm")?30:60,id:"emo_"+name.toLowerCase()});
    const out=el("div",{class:"value-badge", html:range.value});
    range.addEventListener("input",()=>{out.textContent=range.value;updateKPIs();updateProTips();});
    row.appendChild(range); row.appendChild(out); root.appendChild(row);
  });
}

function pctRelief(before,after){if(before<=0)return 0;return Math.max(0,Math.round((before-after)/before*100));}
function summarizeEmotions(){
  const vals=EMOTIONS.map(n=>({name:n,val:parseInt(document.getElementById("emo_"+n.toLowerCase()).value,10)}));
  const avg=Math.round(vals.reduce((a,b)=>a+b.val,0)/vals.length);
  const top=[...vals].sort((a,b)=>b.val-a.val).slice(0,2);
  return {vals,avg,top};
}
function inferDistortions(text){const t=(text||"").toLowerCase();const found=[];DISTORTIONS.forEach(d=>{if(d.hints.some(h=>t.includes(h)))found.push(d.label)});return Array.from(new Set(found));}

function kpiTiles(containerId){
  const before=parseInt(document.getElementById("distressBefore").value,10);
  const after=parseInt(document.getElementById("distressAfter").value,10);
  const relief=pctRelief(before,after);
  const {avg,top}=summarizeEmotions();
  const k=document.getElementById(containerId); k.innerHTML="";
  [{label:"Avg intensity",value:avg+"/100"},{label:"Relief after reframe",value:relief+"%"},{label:"Top emotions",value:top.map(t=>t.name+" "+t.val).join(", ")||"—"}]
   .forEach(t=>{const tile=el("div",{class:"tile"});tile.appendChild(el("div",{class:"big",html:t.value}));tile.appendChild(el("div",{class:"small",html:t.label}));k.appendChild(tile);});
}
function updateKPIs(){kpiTiles("kpis");kpiTiles("coverKpis");}
function updateProTips(){
  const {top}=summarizeEmotions();const tipsEl=document.getElementById("proTips");const recs=[];
  top.forEach(t=>{const libs=REFRAME_LIB[t.name]||[];if(t.val>=50&&libs.length){recs.push(`<span class="pill">Try: ${libs[0]}</span>`);}});
  tipsEl.innerHTML=recs.join(" ")||"Pro tip: Use evidence for and against to find a balanced reframe.";
}
function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#039;" }[m]));
}
function generateSessionId(){return "VN-"+Math.random().toString(36).slice(2,8).toUpperCase();}

function generateReport(){
  const entryDate=document.getElementById("entryDate").value;
  const sessionId=document.getElementById("sessionId").value||generateSessionId();
  document.getElementById("sessionId").value=sessionId;
  const situation=document.getElementById("situation").value;
  const thought=document.getElementById("thought").value;
  const evidenceFor=document.getElementById("evidenceFor").value;
  const evidenceAgainst=document.getElementById("evidenceAgainst").value;
  const actions=document.getElementById("actions").value;
  const reframe=document.getElementById("reframe").value;
  const coreMeaning=document.getElementById("coreMeaning").value;
  const nextStep=document.getElementById("nextStep").value;
  const before=parseInt(document.getElementById("distressBefore").value,10);
  const after=parseInt(document.getElementById("distressAfter").value,10);
  const relief=pctRelief(before,after);
  const {vals,avg,top}=summarizeEmotions();
  const distortions=inferDistortions(thought);

  document.getElementById("coverMeta").textContent=`Session ${sessionId} • ${entryDate||new Date().toISOString().slice(0,10)}`;

  document.getElementById("repContext").innerHTML=`<div><strong>Date:</strong> ${escapeHtml(entryDate)}</div>
  <div><strong>Session ID:</strong> ${escapeHtml(sessionId)}</div>
  <div><strong>Situation:</strong><br>${escapeHtml(situation)}</div>
  <div><strong>Automatic Thought:</strong><br>${escapeHtml(thought)}</div>`;

  document.getElementById("repEvidence").innerHTML=`<div><em>For:</em> ${escapeHtml(evidenceFor)}</div>
  <div><em>Against:</em> ${escapeHtml(evidenceAgainst)}</div>`;

  document.getElementById("repEmotions").innerHTML=vals.map(v=>`<span class="pill">${v.name}: ${v.val}</span>`).join(" ");
  document.getElementById("repReframe").innerHTML=`<div><strong>Balanced Thought:</strong><br>${escapeHtml(reframe)}</div>
  <div><strong>Core Meaning:</strong><br>${escapeHtml(coreMeaning)}</div>
  <div><strong>Next Step:</strong> ${escapeHtml(nextStep)}</div>`;

  document.getElementById("repActions").innerHTML=`<div><strong>Actions / Reactions:</strong><br>${escapeHtml(actions)}</div>
  <div><strong>Distress change:</strong> ${before} → ${after} (${relief}% relief)</div>`;

  const insightChips=[`<span class="pill">Avg intensity: ${avg}/100</span>`,`<span class="pill">Top: ${top.map(t=>t.name+" "+t.val).join(", ")||"—"}</span>`,distortions.length?`<span class="pill">Distortions: ${distortions.join(", ")}</span>`:`<span class="pill">Distortions: none detected</span>`].join(" ");
  document.getElementById("repInsights").innerHTML=insightChips;
  document.getElementById("report").style.display="block";

  return {entryDate,sessionId,situation,thought,evidenceFor,evidenceAgainst,actions,reframe,coreMeaning,nextStep,before,after,relief,emotions:vals,avg,top,distortions};
}

function resetAll(){
  document.querySelectorAll("input[type='text'], textarea").forEach(i=>i.value="");
  document.getElementById("entryDate").value="";
  EMOTIONS.forEach(n=>document.getElementById("emo_"+n.toLowerCase()).value=(n==="Joy"||n==="Calm")?30:60);
  document.getElementById("distressBefore").value=60; document.getElementById("dbv").textContent=60;
  document.getElementById("distressAfter").value=30; document.getElementById("dav").textContent=30;
  document.getElementById("report").style.display="none";
  updateKPIs(); updateProTips();
}
function quickExit(){document.body.innerHTML="<div style='padding:20px;font-family:sans-serif'>Thanks for visiting.</div>";history.replaceState({}, "", "/");}

document.addEventListener("DOMContentLoaded",()=>{
  buildEmotionUI(); updateKPIs(); updateProTips();
  // Ripple origin
  document.querySelectorAll('button').forEach(b=>{
    b.addEventListener('pointerdown',e=>{
      const r=b.getBoundingClientRect();
      b.style.setProperty('--x', (e.clientX - r.left)+'px');
      b.style.setProperty('--y', (e.clientY - r.top)+'px');
    }, {passive:true});
  });
  document.getElementById("gen").addEventListener("click",()=>{
    window.__data=generateReport();
    window.scrollTo({top:document.getElementById("report").offsetTop-8,behavior:"smooth"});
  });
  document.getElementById("printBtn").addEventListener("click",()=>{
    if(!window.__data){ window.__data = generateReport(); }
    updateKPIs();
    document.getElementById("report").style.display="block";
    requestAnimationFrame(()=>window.print());
  });
  document.getElementById("resetBtn").addEventListener("click",resetAll);
  document.getElementById("quickExit").addEventListener("click",quickExit);
});
</script>
</body>
</html>
